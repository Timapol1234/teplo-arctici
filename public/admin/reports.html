<!DOCTYPE html>
<html class="light" lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Админ: Управление отчетами - Тепло Арктики</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13a4ec",
            "background-light": "#f6f7f8",
            "background-dark": "#101c22",
          },
          fontFamily: {
            "display": ["Inter"]
          },
          borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
        },
      },
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .active-nav {
      background-color: #13a4ec20;
      color: #13a4ec;
      border-right: 4px solid #13a4ec;
    }
    /* Стили для drag-and-drop зоны */
    .upload-zone {
      border: 2px dashed #cbd5e1;
      transition: all 0.2s ease;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: #13a4ec;
      background-color: rgba(19, 164, 236, 0.05);
    }
    .upload-zone.drag-over {
      transform: scale(1.01);
    }
    .dark .upload-zone {
      border-color: #475569;
    }
    .dark .upload-zone:hover, .dark .upload-zone.drag-over {
      border-color: #13a4ec;
      background-color: rgba(19, 164, 236, 0.1);
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col sticky top-0 h-screen">
      <div class="p-6 flex items-center gap-3">
        <div class="size-10 rounded-full bg-primary flex items-center justify-center text-white shadow-lg">
          <span class="material-symbols-outlined">ac_unit</span>
        </div>
        <div class="flex flex-col">
          <h1 class="text-[#0d171b] dark:text-white text-base font-bold leading-tight">Тепло Арктики</h1>
          <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">Админ-панель</p>
        </div>
      </div>
      <nav class="flex-1 px-3 space-y-1">
        <a class="flex items-center gap-3 px-3 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" href="/admin/dashboard.html">
          <span class="material-symbols-outlined">receipt_long</span>
          <span class="text-sm font-medium">Транзакции</span>
        </a>
        <a class="flex items-center gap-3 px-3 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" href="/admin/campaigns.html">
          <span class="material-symbols-outlined">handshake</span>
          <span class="text-sm font-medium">Управление сборами</span>
        </a>
        <a class="flex items-center gap-3 px-3 py-3 rounded-lg active-nav text-primary font-semibold" href="/admin/reports.html">
          <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1">bar_chart</span>
          <span class="text-sm">Отчеты</span>
        </a>
      </nav>
      <div class="p-4 border-t border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-3 p-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors" data-logout>
          <div class="size-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center">
            <span class="material-symbols-outlined text-lg">person</span>
          </div>
          <div class="flex-1 overflow-hidden">
            <p id="admin-name" class="text-sm font-medium truncate">Администратор</p>
            <p class="text-xs text-slate-500 truncate">Выйти</p>
          </div>
          <span class="material-symbols-outlined text-slate-400">logout</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
      <div class="max-w-6xl mx-auto space-y-8">
        <!-- Header -->
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Управление отчетами о расходах</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-1">Прозрачная отчетность о распределении собранных средств</p>
          </div>
          <button id="create-report-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2.5 rounded-lg font-bold shadow-md shadow-primary/20 transition-all flex items-center gap-2">
            <span class="material-symbols-outlined">add</span>
            Добавить отчет
          </button>
        </div>

        <!-- Reports List -->
        <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-800">
                  <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Дата расхода</th>
                  <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Описание</th>
                  <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Сбор</th>
                  <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Поставщик</th>
                  <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Сумма</th>
                  <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-center">Документ</th>
                  <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Действия</th>
                </tr>
              </thead>
              <tbody id="reports-table" class="divide-y divide-slate-100 dark:divide-slate-800">
                <tr>
                  <td colspan="7" class="px-6 py-12 text-center text-slate-500">
                    <div class="flex flex-col items-center gap-2">
                      <span class="material-symbols-outlined text-5xl animate-pulse">hourglass_empty</span>
                      <p>Загрузка отчетов...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Info Card -->
        <div class="bg-primary/5 dark:bg-primary/10 border border-primary/20 rounded-xl p-6">
          <div class="flex gap-4">
            <div class="bg-primary rounded-lg p-3 h-fit text-white">
              <span class="material-symbols-outlined">info</span>
            </div>
            <div>
              <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">О прозрачности расходов</h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                Каждый отчет о расходах публикуется на сайте и доступен всем донорам. Это гарантирует полную прозрачность
                использования собранных средств и укрепляет доверие к нашей организации. Прикладывайте чеки и документы
                к каждому отчету для максимальной открытости.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Report Form Modal -->
  <div id="report-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-6 py-4 flex justify-between items-center">
        <h3 id="modal-title" class="text-xl font-bold text-slate-900 dark:text-white">Добавить отчет о расходе</h3>
        <button id="close-modal" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <form id="report-form" class="p-6 space-y-6">
        <!-- Campaign Select -->
        <div>
          <label class="block mb-2 text-sm font-semibold text-slate-700 dark:text-slate-300">Целевой сбор</label>
          <select id="report-campaign" name="campaign_id" class="w-full h-12 px-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none" required>
            <option value="">Загрузка...</option>
          </select>
        </div>

        <!-- Expense Date -->
        <div>
          <label class="block mb-2 text-sm font-semibold text-slate-700 dark:text-slate-300">Дата расхода</label>
          <input id="report-date" name="expense_date" type="date" class="w-full h-12 px-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none" required/>
        </div>

        <!-- Amount -->
        <div>
          <label class="block mb-2 text-sm font-semibold text-slate-700 dark:text-slate-300">Сумма расхода (₽)</label>
          <input id="report-amount" name="amount" type="number" min="0" step="0.01" class="w-full h-12 px-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none" placeholder="0.00" required/>
        </div>

        <!-- Description -->
        <div>
          <label class="block mb-2 text-sm font-semibold text-slate-700 dark:text-slate-300">Описание расхода</label>
          <textarea id="report-description" name="description" rows="4" class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none resize-none" placeholder="Подробно опишите, на что были потрачены средства..." required></textarea>
        </div>

        <!-- Vendor Name -->
        <div>
          <label class="block mb-2 text-sm font-semibold text-slate-700 dark:text-slate-300">Поставщик / Получатель</label>
          <input id="report-vendor" name="vendor_name" type="text" class="w-full h-12 px-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none" placeholder="Название организации или ФИО"/>
        </div>

        <!-- Receipt Upload/URL -->
        <div>
          <label class="block mb-2 text-sm font-semibold text-slate-700 dark:text-slate-300">Чек / Документ</label>

          <!-- Переключатель режима -->
          <div class="flex gap-2 mb-3">
            <button type="button" id="upload-mode-file" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-primary text-white">
              Загрузить файл
            </button>
            <button type="button" id="upload-mode-url" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700">
              Указать ссылку
            </button>
          </div>

          <!-- Режим загрузки файла -->
          <div id="file-upload-container">
            <div id="upload-zone" class="upload-zone rounded-lg p-6 text-center cursor-pointer">
              <input type="file" id="receipt-file" name="receipt_file" accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx" class="hidden"/>
              <div id="upload-placeholder" class="flex flex-col items-center gap-2">
                <span class="material-symbols-outlined text-4xl text-slate-400">cloud_upload</span>
                <p class="text-sm font-medium text-slate-600 dark:text-slate-400">Нажмите для загрузки или перетащите файл сюда</p>
                <p class="text-xs text-slate-400">JPG, PNG, PDF, DOC до 10MB</p>
              </div>
              <div id="file-preview" class="hidden flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-800 rounded-lg">
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined text-primary">description</span>
                  <div class="text-left">
                    <p id="file-name" class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate max-w-[200px]"></p>
                    <p id="file-size" class="text-xs text-slate-500"></p>
                  </div>
                </div>
                <button type="button" id="clear-file-btn" class="p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded transition-colors">
                  <span class="material-symbols-outlined text-slate-500">close</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Режим ссылки -->
          <div id="url-input-container" class="hidden">
            <input id="report-receipt" name="receipt_url" type="url" class="w-full h-12 px-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none" placeholder="https://example.com/receipt.pdf"/>
            <p class="mt-1 text-xs text-slate-500">Вставьте ссылку на документ</p>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-3 pt-4 border-t border-slate-200 dark:border-slate-800">
          <button type="button" id="cancel-report-btn" class="flex-1 px-6 py-2.5 text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
            Отмена
          </button>
          <button type="submit" id="save-report-btn" class="flex-1 bg-primary hover:bg-primary/90 text-white px-6 py-2.5 rounded-lg font-bold transition-all">
            Сохранить отчет
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/admin.js?v=6"></script>
  <script>
    let editingReportId = null;
    let currentUploadMode = 'file';

    // Переключение режима загрузки
    function setUploadMode(mode) {
      currentUploadMode = mode;
      const fileBtn = document.getElementById('upload-mode-file');
      const urlBtn = document.getElementById('upload-mode-url');
      const fileContainer = document.getElementById('file-upload-container');
      const urlContainer = document.getElementById('url-input-container');

      if (mode === 'file') {
        fileBtn.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-primary text-white';
        urlBtn.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700';
        fileContainer.classList.remove('hidden');
        urlContainer.classList.add('hidden');
        document.getElementById('report-receipt').value = '';
      } else {
        urlBtn.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-primary text-white';
        fileBtn.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700';
        urlContainer.classList.remove('hidden');
        fileContainer.classList.add('hidden');
        clearFileSelection();
      }
    }

    // Обработка выбора файла
    function handleFileSelect(input) {
      const file = input.files[0];
      if (!file) return;

      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        UI.showError('Файл слишком большой. Максимальный размер: 10MB');
        input.value = '';
        return;
      }

      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      if (!allowedTypes.includes(file.type)) {
        UI.showError('Недопустимый тип файла. Разрешены: JPG, PNG, GIF, WebP, PDF, DOC, DOCX');
        input.value = '';
        return;
      }

      // Показываем превью
      document.getElementById('upload-placeholder').classList.add('hidden');
      document.getElementById('file-preview').classList.remove('hidden');
      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-size').textContent = formatFileSize(file.size);
    }

    // Очистка выбранного файла
    function clearFileSelection(event) {
      if (event) event.stopPropagation();
      document.getElementById('receipt-file').value = '';
      document.getElementById('upload-placeholder').classList.remove('hidden');
      document.getElementById('file-preview').classList.add('hidden');
    }

    // Форматирование размера файла
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Инициализация загрузки файлов
    function initUploadHandlers() {
      const uploadZone = document.getElementById('upload-zone');
      const fileInput = document.getElementById('receipt-file');
      const clearBtn = document.getElementById('clear-file-btn');
      const fileModeBtn = document.getElementById('upload-mode-file');
      const urlModeBtn = document.getElementById('upload-mode-url');

      if (!uploadZone) return;

      // Клик на зону загрузки
      uploadZone.addEventListener('click', (e) => {
        if (e.target.closest('#clear-file-btn')) return;
        fileInput.click();
      });

      // Выбор файла
      fileInput.addEventListener('change', () => {
        handleFileSelect(fileInput);
      });

      // Очистка файла
      clearBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        clearFileSelection();
      });

      // Переключение режимов
      fileModeBtn.addEventListener('click', () => setUploadMode('file'));
      urlModeBtn.addEventListener('click', () => setUploadMode('url'));

      // Drag & Drop
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => {
          uploadZone.classList.add('drag-over');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => {
          uploadZone.classList.remove('drag-over');
        });
      });

      uploadZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect(fileInput);
        }
      });
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', async () => {
      const isAuth = await checkAuth();
      if (!isAuth) return;

      initLogout();
      initThemeToggle();
      loadAdminInfo();
      initUploadHandlers();
      await loadCampaigns();
      await loadReports();

      // Обработчики модального окна
      document.getElementById('create-report-btn').addEventListener('click', () => showReportModal());
      document.getElementById('close-modal').addEventListener('click', hideReportModal);
      document.getElementById('cancel-report-btn').addEventListener('click', hideReportModal);
      document.getElementById('report-form').addEventListener('submit', handleReportSubmit);

      // Закрытие модального окна по клику на фон
      document.getElementById('report-modal').addEventListener('click', (e) => {
        if (e.target.id === 'report-modal') {
          hideReportModal();
        }
      });

      // Установить сегодняшнюю дату по умолчанию
      document.getElementById('report-date').valueAsDate = new Date();
    });

    // Загрузка информации администратора
    function loadAdminInfo() {
      const adminData = TokenManager.getAdminData();
      if (adminData) {
        document.getElementById('admin-name').textContent = adminData.full_name || adminData.email;
      }
    }

    // Загрузка списка сборов
    async function loadCampaigns() {
      try {
        const campaigns = await AdminAPI.getCampaigns();
        const select = document.getElementById('report-campaign');

        select.innerHTML = '<option value="">Выберите сбор</option>' +
          campaigns.map(c => `<option value="${c.id}">${c.title}</option>`).join('');
      } catch (error) {
        UI.showError('Ошибка загрузки сборов: ' + error.message);
      }
    }

    // Загрузка списка отчетов
    async function loadReports() {
      try {
        const reports = await AdminAPI.getReports();
        renderReports(reports);
      } catch (error) {
        UI.showError('Ошибка загрузки отчетов: ' + error.message);
        document.getElementById('reports-table').innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-12 text-center text-red-500">
              <div class="flex flex-col items-center gap-2">
                <span class="material-symbols-outlined text-5xl">error</span>
                <p>Ошибка загрузки данных</p>
              </div>
            </td>
          </tr>
        `;
      }
    }

    // Отображение отчетов
    function renderReports(reports) {
      const tbody = document.getElementById('reports-table');

      if (reports.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-12 text-center text-slate-500">
              <div class="flex flex-col items-center gap-2">
                <span class="material-symbols-outlined text-5xl">description</span>
                <p class="mb-2">Нет отчетов о расходах</p>
                <button id="create-first-report-btn" class="bg-primary text-white px-6 py-2 rounded-lg font-bold hover:bg-primary/90 transition-all">
                  Создать первый отчет
                </button>
              </div>
            </td>
          </tr>
        `;
        document.getElementById('create-first-report-btn').addEventListener('click', () => showReportModal());
        return;
      }

      tbody.innerHTML = reports.map(r => {
        const expenseDate = UI.formatDate(r.expense_date);

        return `
          <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors">
            <td class="px-6 py-4">
              <span class="text-sm font-semibold text-slate-900 dark:text-white">${expenseDate}</span>
            </td>
            <td class="px-6 py-4">
              <p class="text-sm text-slate-700 dark:text-slate-300 max-w-md line-clamp-2">${r.description}</p>
            </td>
            <td class="px-6 py-4">
              <span class="inline-flex px-2 py-1 rounded-md bg-primary/5 text-primary text-xs font-bold">${r.campaign_title}</span>
            </td>
            <td class="px-6 py-4">
              <span class="text-sm text-slate-600 dark:text-slate-400">${r.vendor_name || '—'}</span>
            </td>
            <td class="px-6 py-4 text-right">
              <span class="text-sm font-black text-slate-900 dark:text-white">${UI.formatAmount(r.amount)}</span>
            </td>
            <td class="px-6 py-4 text-center">
              ${r.receipt_url ? `
                <a href="${r.receipt_url}" target="_blank" class="inline-flex items-center gap-1 text-xs text-primary hover:underline">
                  <span class="material-symbols-outlined text-sm">description</span>
                  Документ
                </a>
              ` : '<span class="text-xs text-slate-400">—</span>'}
            </td>
            <td class="px-6 py-4 text-right">
              <div class="flex items-center justify-end gap-2">
                <button data-edit-report="${r.id}" class="p-1.5 text-slate-400 hover:text-primary transition-colors" title="Редактировать">
                  <span class="material-symbols-outlined text-xl">edit</span>
                </button>
                <button data-delete-report="${r.id}" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors" title="Удалить">
                  <span class="material-symbols-outlined text-xl">delete</span>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // Привязываем обработчики
      attachReportEventListeners();
    }

    // Показать модальное окно
    function showReportModal(report = null) {
      editingReportId = report?.id || null;
      document.getElementById('report-modal').classList.remove('hidden');

      // Сбрасываем форму загрузки
      setUploadMode('file');
      clearFileSelection();

      if (report) {
        document.getElementById('modal-title').textContent = 'Редактировать отчет';
        document.getElementById('report-campaign').value = report.campaign_id;
        document.getElementById('report-date').value = report.expense_date.split('T')[0];
        document.getElementById('report-amount').value = report.amount;
        document.getElementById('report-description').value = report.description;
        document.getElementById('report-vendor').value = report.vendor_name || '';
        document.getElementById('save-report-btn').textContent = 'Обновить отчет';

        // Если есть ссылка на документ, переключаемся в режим URL
        if (report.receipt_url) {
          setUploadMode('url');
          document.getElementById('report-receipt').value = report.receipt_url;
        }
      } else {
        document.getElementById('modal-title').textContent = 'Добавить отчет о расходе';
        document.getElementById('report-form').reset();
        document.getElementById('report-date').valueAsDate = new Date();
        document.getElementById('save-report-btn').textContent = 'Сохранить отчет';
      }
    }

    // Скрыть модальное окно
    function hideReportModal() {
      document.getElementById('report-modal').classList.add('hidden');
      editingReportId = null;
    }

    // Редактирование отчета
    async function editReport(id) {
      try {
        const reports = await AdminAPI.getReports();
        const report = reports.find(r => r.id === id);
        if (report) {
          showReportModal(report);
        }
      } catch (error) {
        UI.showError('Ошибка загрузки отчета: ' + error.message);
      }
    }

    // Удаление отчета
    async function deleteReport(id) {
      if (!confirm('Вы уверены, что хотите удалить этот отчет?')) {
        return;
      }

      try {
        await AdminAPI.deleteReport(id);
        UI.showNotification('Отчет успешно удален');
        await loadReports();
      } catch (error) {
        UI.showError('Ошибка удаления отчета: ' + error.message);
      }
    }

    // Обработка отправки формы
    async function handleReportSubmit(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);

      // Проверка обязательных полей
      const campaignId = parseInt(formData.get('campaign_id'));
      if (!campaignId) {
        UI.showError('Выберите целевой сбор');
        return;
      }

      // Если режим URL и есть файл - удаляем файл из formData
      // Если режим file и нет файла - удаляем receipt_url из formData
      const fileInput = document.getElementById('receipt-file');
      const hasFile = fileInput.files && fileInput.files.length > 0;
      const receiptUrl = formData.get('receipt_url');

      if (currentUploadMode === 'url') {
        formData.delete('receipt_file');
      } else {
        formData.delete('receipt_url');
        if (!hasFile) {
          // Если нет ни файла, ни URL - это нормально, поле опционально
        }
      }

      try {
        const token = TokenManager.get();
        const url = editingReportId
          ? `/api/admin/reports/${editingReportId}`
          : '/api/admin/reports';
        const method = editingReportId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Ошибка сервера');
        }

        UI.showNotification(editingReportId ? 'Отчет успешно обновлен' : 'Отчет успешно создан');
        hideReportModal();
        await loadReports();
      } catch (error) {
        UI.showError('Ошибка сохранения отчета: ' + error.message);
      }
    }

    // Привязка обработчиков для кнопок редактирования/удаления
    function attachReportEventListeners() {
      document.querySelectorAll('[data-edit-report]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.editReport);
          editReport(id);
        });
      });

      document.querySelectorAll('[data-delete-report]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.deleteReport);
          deleteReport(id);
        });
      });
    }
  </script>
</body>
</html>
