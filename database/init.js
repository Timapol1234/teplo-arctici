const fs = require('fs');
const path = require('path');
const bcrypt = require('bcrypt');
const crypto = require('crypto');
const { Pool } = require('pg');
require('dotenv').config();

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
function checkPasswordStrength(password) {
  const issues = [];

  if (password.length < 10) {
    issues.push('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 10 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²');
  }
  if (!/[A-Z]/.test(password)) {
    issues.push('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğµ Ğ±ÑƒĞºĞ²Ñ‹');
  }
  if (!/[a-z]/.test(password)) {
    issues.push('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ±ÑƒĞºĞ²Ñ‹');
  }
  if (!/[0-9]/.test(password)) {
    issues.push('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ†Ğ¸Ñ„Ñ€Ñ‹');
  }
  if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
    issues.push('Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¿ĞµÑ†ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ (!@#$%^&*)');
  }

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ ÑĞ»Ğ°Ğ±Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğ¸
  const weakPasswords = ['admin123', 'password', '123456', 'admin', 'qwerty', 'change_this'];
  if (weakPasswords.some(weak => password.toLowerCase().includes(weak))) {
    issues.push('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½ÑƒÑ ÑĞ»Ğ°Ğ±ÑƒÑ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ');
  }

  return issues;
}

// Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
function generateSecurePassword() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let password = '';
  const randomBytes = crypto.randomBytes(16);
  for (let i = 0; i < 16; i++) {
    password += chars[randomBytes[i] % chars.length];
  }
  return password;
}

async function initDatabase() {
  console.log('');
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘   ğŸ—„ï¸  Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… PostgreSQL â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');

  if (!process.env.DATABASE_URL) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: DATABASE_URL Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ² .env');
    console.error('');
    console.error('ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ PostgreSQL:');
    console.error('DATABASE_URL=postgresql://user:password@localhost:5432/teplo_arctici');
    console.error('');
    process.exit(1);
  }

  const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
  });

  try {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ
    await pool.query('SELECT NOW()');
    console.log('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº PostgreSQL ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾');

    // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ SQL ÑÑ…ĞµĞ¼Ñƒ
    const schemaPath = path.join(__dirname, 'schema.sql');
    const schema = fs.readFileSync(schemaPath, 'utf8');

    // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ SQL ÑÑ…ĞµĞ¼Ñƒ
    await pool.query(schema);
    console.log('âœ… Ğ¡Ñ…ĞµĞ¼Ğ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°');

    // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
    const adminEmail = process.env.ADMIN_EMAIL || 'admin@teplo-arctici.ru';
    let adminPassword = process.env.ADMIN_PASSWORD;
    let passwordGenerated = false;

    // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ Ğ¸Ğ»Ğ¸ ÑÑ‚Ğ¾ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğ¹ - Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹
    if (!adminPassword || adminPassword === 'admin123' || adminPassword.includes('CHANGE_THIS')) {
      adminPassword = generateSecurePassword();
      passwordGenerated = true;
      console.log('');
      console.log('âš ï¸  ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ Ğ² .env - ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸');
    } else {
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
      const passwordIssues = checkPasswordStrength(adminPassword);
      if (passwordIssues.length > 0) {
        console.log('');
        console.log('âš ï¸  ĞŸĞ Ğ•Ğ”Ğ£ĞŸĞ Ğ•Ğ–Ğ”Ğ•ĞĞ˜Ğ¯ Ğ ĞŸĞĞ ĞĞ›Ğ•:');
        passwordIssues.forEach(issue => console.log(`   - ${issue}`));

        if (process.env.NODE_ENV === 'production') {
          console.error('');
          console.error('âŒ Ğ’ production Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ!');
          await pool.end();
          process.exit(1);
        }
      }
    }

    const passwordHash = await bcrypt.hash(adminPassword, 12);

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ñ Ñ€Ğ¾Ğ»ÑŒÑ super_admin
    await pool.query(
      `INSERT INTO admins (email, password_hash, full_name, role, is_active)
       VALUES ($1, $2, $3, $4, $5)
       ON CONFLICT (email) DO UPDATE SET password_hash = $2, full_name = $3, role = $4, is_active = $5`,
      [adminEmail, passwordHash, 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€', 'super_admin', true]
    );
    console.log('âœ… Ğ¡ÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½');

    console.log('');
    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚  ğŸ” Ğ”ĞĞĞĞ«Ğ• Ğ”Ğ›Ğ¯ Ğ’Ğ¥ĞĞ”Ğ Ğ’ ĞĞ”ĞœĞ˜Ğ-ĞŸĞĞĞ•Ğ›Ğ¬        â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log(`â”‚  ğŸ“§ Email:  ${adminEmail.padEnd(30)}â”‚`);
    console.log(`â”‚  ğŸ”‘ ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ: ${adminPassword.padEnd(30)}â”‚`);
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');

    if (passwordGenerated) {
      console.log('');
      console.log('ğŸ“ Ğ¡ĞĞ¥Ğ ĞĞĞ˜Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ ĞŸĞĞ ĞĞ›Ğ¬! ĞĞ½ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½ ÑĞ½Ğ¾Ğ²Ğ°.');
      console.log('   Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµĞ³Ğ¾ Ğ² .env Ñ„Ğ°Ğ¹Ğ»:');
      console.log(`   ADMIN_PASSWORD=${adminPassword}`);
    }

    console.log('');
    console.log('âš ï¸  Ğ’ĞĞ–ĞĞ: Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ…Ğ¾Ğ´Ğ°!');
    console.log('');
    console.log('ğŸ‰ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!');
    console.log('');

    await pool.end();
    process.exit(0);
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error.message);
    await pool.end();
    process.exit(1);
  }
}

initDatabase();
